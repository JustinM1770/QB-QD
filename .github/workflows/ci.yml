name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  # =========================================
  # Job 1: Verificaci√≥n de sintaxis PHP
  # =========================================
  syntax-check:
    name: PHP Syntax Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'

      - name: Check PHP syntax
        run: |
          echo "üîç Verificando sintaxis PHP..."
          find . -name "*.php" -not -path "./vendor/*" -not -path "./node_modules/*" | head -200 | xargs -I {} php -l {} | grep -v "No syntax errors"
          if [ $? -eq 0 ]; then
            echo "‚ùå Se encontraron errores de sintaxis"
            exit 1
          fi
          echo "‚úÖ No se encontraron errores de sintaxis"

  # =========================================
  # Job 2: Tests unitarios con PHPUnit
  # =========================================
  tests:
    name: PHPUnit Tests
    runs-on: ubuntu-latest
    needs: syntax-check

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: app_delivery_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: pdo, pdo_mysql, mbstring, json, curl
          coverage: xdebug

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Create .env file
        run: |
          cp .env.example .env
          sed -i 's/DB_HOST=.*/DB_HOST=127.0.0.1/' .env
          sed -i 's/DB_NAME=.*/DB_NAME=app_delivery_test/' .env
          sed -i 's/DB_USER=.*/DB_USER=root/' .env
          sed -i 's/DB_PASS=.*/DB_PASS=root/' .env

      - name: Run PHPUnit tests
        run: |
          mkdir -p tests/reports
          ./vendor/bin/phpunit --testsuite=Unit --colors=always
        env:
          DB_HOST: 127.0.0.1
          DB_NAME: app_delivery_test
          DB_USER: root
          DB_PASS: root

  # =========================================
  # Job 3: Verificaci√≥n de seguridad
  # =========================================
  security:
    name: Security Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded credentials
        run: |
          echo "üîç Buscando credenciales hardcodeadas..."

          # Buscar Stripe secret keys hardcodeadas
          if grep -r "sk_live_[a-zA-Z0-9]" --include="*.php" --exclude-dir=vendor --exclude-dir=node_modules .; then
            echo "‚ùå ERROR: Se encontraron Stripe secret keys hardcodeadas"
            exit 1
          fi

          # Buscar MercadoPago tokens hardcodeados (formato espec√≠fico)
          if grep -rE "APP_USR-[0-9a-f]{8}-[0-9a-f]{4}" --include="*.php" --exclude-dir=vendor --exclude-dir=node_modules . | grep -v ".env" | grep -v "env("; then
            echo "‚ùå ERROR: Se encontraron MercadoPago tokens hardcodeados"
            exit 1
          fi

          # Buscar passwords hardcodeados (patrones comunes)
          if grep -rE "(password|passwd|pwd)\s*=\s*['\"][^'\$][^'\"]{5,}['\"]" --include="*.php" --exclude-dir=vendor --exclude-dir=node_modules . | grep -v "password_hash" | grep -v "password_verify" | grep -v "// " | head -5; then
            echo "‚ö†Ô∏è ADVERTENCIA: Posibles passwords hardcodeados encontrados (revisar manualmente)"
          fi

          echo "‚úÖ No se encontraron credenciales cr√≠ticas hardcodeadas"

      - name: Check for sensitive files
        run: |
          echo "üîç Verificando que archivos sensibles no est√©n expuestos..."

          # Verificar que .env no est√© en el repositorio
          if [ -f ".env" ] && ! grep -q ".env" .gitignore; then
            echo "‚ùå ERROR: .env existe y no est√° en .gitignore"
            exit 1
          fi

          # Verificar que hay .env.example
          if [ ! -f ".env.example" ]; then
            echo "‚ùå ERROR: Falta .env.example"
            exit 1
          fi

          echo "‚úÖ Archivos sensibles correctamente configurados"

  # =========================================
  # Job 4: An√°lisis de c√≥digo (opcional)
  # =========================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'

      - name: Check for common issues
        run: |
          echo "üîç Verificando problemas comunes..."

          # Buscar display_errors en c√≥digo de producci√≥n (no tests)
          DISPLAY_ERRORS=$(grep -r "display_errors.*1\|display_errors.*On" --include="*.php" --exclude-dir=vendor --exclude-dir=node_modules --exclude-dir=tests --exclude-dir=_testing_files . || true)
          if [ -n "$DISPLAY_ERRORS" ]; then
            echo "‚ö†Ô∏è ADVERTENCIA: display_errors encontrado en c√≥digo de producci√≥n:"
            echo "$DISPLAY_ERRORS"
          fi

          # Buscar TODO/FIXME
          TODO_COUNT=$(grep -r "TODO\|FIXME\|XXX" --include="*.php" --exclude-dir=vendor --exclude-dir=node_modules . | wc -l || true)
          echo "üìù TODOs/FIXMEs encontrados: $TODO_COUNT"

          echo "‚úÖ An√°lisis de calidad completado"
