<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Cloudflare Bypass</title>
</head>
<body>
    <h1>Test de Bypass Cloudflare</h1>
    
    <button id="testAjax">Probar AJAX Mejorado</button>
    <button id="testForm">Probar Fallback Formulario</button>
    
    <div id="result"></div>

    <script>
        document.getElementById('testAjax').addEventListener('click', function() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Probando AJAX mejorado...';
            
            const baseUrl = window.location.protocol + '//' + window.location.host;
            const updateUrl = baseUrl + '/admin/actualizar_estado_pedido.php';
            
            const formData = new FormData();
            formData.append('id_pedido', '999');
            formData.append('estado', 'test');
            
            fetch(updateUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'User-Agent': navigator.userAgent,
                    'Accept': 'application/json, text/javascript, */*; q=0.01',
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                },
                credentials: 'same-origin',
                mode: 'cors'
            })
            .then(response => {
                console.log('Status:', response.status);
                return response.text();
            })
            .then(text => {
                resultDiv.innerHTML = `
                    <h3>✅ Resultado AJAX</h3>
                    <p>Respuesta: ${text.substring(0, 200)}</p>
                `;
            })
            .catch(error => {
                resultDiv.innerHTML = `
                    <h3>❌ Error AJAX</h3>
                    <p>Error: ${error.message}</p>
                `;
            });
        });
        
        document.getElementById('testForm').addEventListener('click', function() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Probando fallback con formulario...';
            
            // Crear formulario oculto
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/admin/actualizar_estado_pedido.php';
            form.style.display = 'none';
            
            // Agregar campos
            const idPedidoInput = document.createElement('input');
            idPedidoInput.type = 'hidden';
            idPedidoInput.name = 'id_pedido';
            idPedidoInput.value = '999';
            
            const estadoInput = document.createElement('input');
            estadoInput.type = 'hidden';
            estadoInput.name = 'estado';
            estadoInput.value = 'test';
            
            const ajaxInput = document.createElement('input');
            ajaxInput.type = 'hidden';
            ajaxInput.name = 'ajax_fallback';
            ajaxInput.value = '1';
            
            form.appendChild(idPedidoInput);
            form.appendChild(estadoInput);
            form.appendChild(ajaxInput);
            
            document.body.appendChild(form);
            
            // Usar iframe oculto
            const iframe = document.createElement('iframe');
            iframe.name = 'test_response';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            form.target = 'test_response';
            
            iframe.onload = function() {
                try {
                    const response = iframe.contentDocument.body.textContent;
                    resultDiv.innerHTML = `
                        <h3>✅ Resultado Formulario</h3>
                        <p>Respuesta: ${response.substring(0, 200)}</p>
                    `;
                } catch (e) {
                    resultDiv.innerHTML = `
                        <h3>❌ Error Formulario</h3>
                        <p>Error: ${e.message}</p>
                    `;
                } finally {
                    document.body.removeChild(form);
                    document.body.removeChild(iframe);
                }
            };
            
            form.submit();
        });
    </script>
</body>
</html>